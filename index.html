<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: 'Arial', sans-serif;
      direction: rtl;
      background-color: #f0f0f0;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    input {
      padding: 6px;
      width: 100%;
    }
    button {
      padding: 6px 10px;
      cursor: pointer;
    }
    img {
      max-width: 100px;
      max-height: 80px;
    }
  </style>

  <script type="module" src="firebase-config.js"></script>
  <script type="module">
    import { getDatabase, ref, set, remove, get, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { database } from './firebase-config.js';

    let rowCount = 0;

    // Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯
    window.addRow = function () {
      const table = document.getElementById("tableBody");
      const row = table.insertRow();
      const code = ++rowCount;

      row.innerHTML = `
        <td>${code}</td>
        <td><input type="text" id="name-${code}" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"></td>
        <td><input type="text" id="phone-${code}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"></td>
        <td><input type="text" id="offer-${code}" placeholder="Ø±Ø§Ø¨Ø· Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±"></td>
        <td><input type="text" id="drawing-${code}" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª"></td>
        <td><button onclick="confirmRow(${code})">ØªØ£ÙƒÙŠØ¯</button></td>
        <td><button onclick="editRow(${code})">ØªØ¹Ø¯ÙŠÙ„</button></td>
        <td><button onclick="sendToContract(${code})">Ø¹Ù‚Ø¯</button></td>
      `;
    };

    // ØªØ£ÙƒÙŠØ¯ ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ø³Ø·Ø±
    window.confirmRow = async function (code) {
      const nameInput = document.getElementById(`name-${code}`);
      const phoneInput = document.getElementById(`phone-${code}`);
      const offerInput = document.getElementById(`offer-${code}`);
      const drawInput = document.getElementById(`drawing-${code}`);

      const name = nameInput.value.trim();
      const phone = phoneInput.value.trim();
      const offerURL = offerInput.value.trim();
      const drawURL = drawInput.value.trim();

      if (!name || !phone || !offerURL || !drawURL) {
        alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆÙˆØ¶Ø¹ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØµÙˆØ±");
        return;
      }

      await set(ref(database, "clients/" + code), {
        name: name,
        phone: phone,
        offerImage: offerURL,
        drawingImage: drawURL
      });

      // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ù†ØµÙˆØµ ÙˆØµÙˆØ±
      const row = nameInput.parentElement.parentElement;
      row.children[1].innerText = name;
      row.children[2].innerText = phone;
      row.children[3].innerHTML = `<img src="${offerURL}" />`;
      row.children[4].innerHTML = `<img src="${drawURL}" />`;

      alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    };

    // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø·Ø±
    window.editRow = function (code) {
      const dbRef = ref(database);
      get(child(dbRef, `clients/${code}`)).then((snapshot) => {
        if (!snapshot.exists()) {
          alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø¹Ø¯ØŒ Ø§Ø¶ØºØ· ØªØ£ÙƒÙŠØ¯ Ø£ÙˆÙ„Ø§Ù‹");
          return;
        }

        const data = snapshot.val();
        const row = document.querySelector(`#tableBody tr:nth-child(${code})`);

        row.children[1].innerHTML = `<input type="text" id="name-${code}" value="${data.name}">`;
        row.children[2].innerHTML = `<input type="text" id="phone-${code}" value="${data.phone}">`;
        row.children[3].innerHTML = `<input type="text" id="offer-${code}" value="${data.offerImage}" placeholder="Ø±Ø§Ø¨Ø· Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±">`;
        row.children[4].innerHTML = `<input type="text" id="drawing-${code}" value="${data.drawingImage}" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª">`;
      });
    };

    // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¹Ù‚ÙˆØ¯
    window.sendToContract = async function (code) {
      const dbRef = ref(database);
      const snapshot = await get(child(dbRef, `clients/${code}`));
      if (!snapshot.exists()) {
        alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø§Ø¶ØºØ· ØªØ£ÙƒÙŠØ¯ Ø£ÙˆÙ„Ø§Ù‹");
        return;
      }

      const data = snapshot.val();

      await set(ref(database, "contracts/" + code), {
        name: data.name,
        phone: data.phone,
        contractImage: data.offerImage,
        accountsImage: data.drawingImage
      });

      await remove(ref(database, "clients/" + code));
      alert("âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯");
      location.reload();
    };

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    window.onload = function () {
      const dbRef = ref(database, "clients");

      get(dbRef).then((snapshot) => {
        if (snapshot.exists()) {
          snapshot.forEach((childSnap) => {
            const code = childSnap.key;
            const data = childSnap.val();

            const table = document.getElementById("tableBody");
            const row = table.insertRow();

            row.innerHTML = `
              <td>${code}</td>
              <td>${data.name}</td>
              <td>${data.phone}</td>
              <td><img src="${data.offerImage}" /></td>
              <td><img src="${data.drawingImage}" /></td>
              <td><button onclick="confirmRow(${code})">ØªØ£ÙƒÙŠØ¯</button></td>
              <td><button onclick="editRow(${code})">ØªØ¹Ø¯ÙŠÙ„</button></td>
              <td><button onclick="sendToContract(${code})">Ø¹Ù‚Ø¯</button></td>
            `;

            // ØªØ­Ø¯ÙŠØ« rowCount Ù„Ùˆ ÙÙŠÙ‡ Ø¨ÙŠØ§Ù†Ø§Øª
            if (+code > rowCount) rowCount = +code;
          });
        }
      });
    };
  </script>
</head>
<body>
  <h2>ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
  <table id="dataTable">
    <thead>
      <tr>
        <th>Ø§Ù„ÙƒÙˆØ¯</th>
        <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
        <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
        <th>Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±</th>
        <th>Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª</th>
        <th>ØªØ£ÙƒÙŠØ¯</th>
        <th>ØªØ¹Ø¯ÙŠÙ„</th>
        <th>Ø¹Ù‚Ø¯</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <br />
  <button onclick="addRow()">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
</body>
</html>
