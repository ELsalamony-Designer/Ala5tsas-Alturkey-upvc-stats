<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>إدارة العملاء</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: #f0f0f0;
            direction: rtl;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        form {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 0 10px #ccc;
            margin-bottom: 20px;
            max-width: 700px;
            margin: auto;
        }
        form input {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }
        form button {
            padding: 10px;
            width: 100%;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        table {
            width: 100%;
            background: white;
            border-collapse: collapse;
            margin-top: 20px;
            max-width: 1000px; /* لجدول أوسع قليلاً */
            margin: 20px auto; /* لتوسيط الجدول */
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
            vertical-align: middle; /* توسيط المحتوى عمودياً في الخلايا */
        }
        th {
            background: #eee;
        }
        .action {
            margin: 2px;
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1em; /* تكبير أيقونات الأزرار */
        }
        .edit { background: #ffc107; color: black; }
        .delete { background: #dc3545; color: white; }
        .contract { background: #007bff; color: white; }
        td img {
            max-width: 100px; /* حجم أكبر للصور عشان تبان أوضح */
            height: auto;
            display: block;
            margin: auto; /* توسيط الصورة */
        }
    </style>
</head>
<body>

    <h1>نظام إدارة العملاء</h1>

    <form id="clientForm">
        <input type="text" id="name" placeholder="اسم العميل" required>
        <input type="text" id="phone" placeholder="رقم الهاتف" required>
        <input type="url" id="estimate" placeholder="رابط صورة عرض السعر" required>
        <input type="url" id="drawings" placeholder="رابط صورة الرسومات" required>
        <button type="submit">➕ إضافة عميل</button>
    </form>

    <table id="clientsTable">
        <thead>
            <tr>
                <th>الكود</th>
                <th>الاسم</th>
                <th>رقم الهاتف</th>
                <th>عرض السعر</th>
                <th>الرسومات</th>
                <th>خيارات</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import {
            getDatabase, ref, push, onValue, set, remove, get, child
        } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

        // بيانات تهيئة Firebase الخاصة بك
        // **ملاحظة هامة:** هذه المفاتيح ظاهرة في الواجهة الأمامية،
        // يجب أن تضمن قواعد أمان Firebase (Firebase Security Rules) الخاصة بك
        // أنها صارمة بما يكفي لمنع الوصول غير المصرح به.
        const firebaseConfig = {
            apiKey: "AIzaSyDgOby-sJuIUs8iCErmqtiMbqMuND5ZtCo",
            authDomain: "ala5tsas-alturkey-stats.firebaseapp.com",
            databaseURL: "https://ala5tsas-alturkey-stats-default-rtdb.firebaseio.com",
            projectId: "ala5tsas-alturkey-stats",
            storageBucket: "ala5tsas-alturkey-stats.appspot.com", // تم تعديلها لتتوافق مع البيانات الجديدة
            messagingSenderId: "649675735929",
            appId: "1:649675735929:web:f90a49614895c6958ea5a8",
            measurementId: "G-X2FHKZT21J"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const clientsRef = ref(db, 'clients');

        const form = document.getElementById("clientForm");
        const tbody = document.querySelector("#clientsTable tbody");

        // دالة لإضافة عميل جديد
        form.addEventListener("submit", async (e) => {
            e.preventDefault(); // منع الإرسال الافتراضي للنموذج
            const name = document.getElementById("name").value;
            const phone = document.getElementById("phone").value;
            const estimate = document.getElementById("estimate").value;
            const drawings = document.getElementById("drawings").value;

            // إنشاء مرجع جديد (key فريد) للعميل
            const newClientRef = push(clientsRef);
            await set(newClientRef, {
                code: newClientRef.key, // استخدام الـ key ككود للعميل
                name,
                phone,
                estimate,
                drawings
            });

            form.reset(); // إفراغ النموذج بعد الإضافة
        });

        // دوال للتعامل مع العمليات (حذف، تعديل، نقل للعقود)
        const deleteClient = async (id) => {
            if (confirm("هل أنت متأكد أنك تريد حذف هذا العميل؟")) {
                try {
                    await remove(ref(db, 'clients/' + id));
                    alert("✅ تم حذف العميل بنجاح.");
                } catch (error) {
                    console.error("خطأ في حذف العميل:", error);
                    alert("❌ حدث خطأ أثناء حذف العميل.");
                }
            }
        };

        const editClient = async (id) => {
            const snapshot = await get(child(ref(db), `clients/${id}`));
            if (snapshot.exists()) {
                const client = snapshot.val();
                const newName = prompt("ادخل الاسم الجديد:", client.name);
                const newPhone = prompt("ادخل رقم الهاتف الجديد:", client.phone);
                const newEstimate = prompt("ادخل رابط صورة عرض السعر الجديد:", client.estimate);
                const newDrawings = prompt("ادخل رابط صورة الرسومات الجديد:", client.drawings);

                // التحقق من أن جميع المدخلات لم تكن فارغة بعد التعديل
                if (newName !== null && newPhone !== null && newEstimate !== null && newDrawings !== null) {
                    try {
                        await set(ref(db, 'clients/' + id), {
                            code: id, // الكود يظل كما هو
                            name: newName,
                            phone: newPhone,
                            estimate: newEstimate,
                            drawings: newDrawings
                        });
                        alert("✅ تم تحديث بيانات العميل بنجاح.");
                    } catch (error) {
                        console.error("خطأ في تحديث العميل:", error);
                        alert("❌ حدث خطأ أثناء تحديث العميل.");
                    }
                } else {
                    alert("لم يتم تحديث البيانات لأن أحد الحقول كان فارغًا أو تم الإلغاء.");
                }
            } else {
                alert("لم يتم العثور على العميل المراد تعديله.");
            }
        };

        const confirmContract = async (id) => {
            const snapshot = await get(child(ref(db), `clients/${id}`));
            if (snapshot.exists()) {
                const client = snapshot.val();
                const contractLink = prompt("ادخل رابط صورة العقد:");
                const accountsLink = prompt("ادخل رابط صورة الحسابات:");

                if (contractLink && accountsLink) {
                    try {
                        await set(ref(db, 'contracts/' + id), {
                            code: client.code,
                            name: client.name,
                            phone: client.phone,
                            contract: contractLink,
                            accounts: accountsLink
                        });
                        alert("✅ تم نقل العميل للعقودات بنجاح.");
                        // يمكنك التفكير في حذف العميل من جدول 'clients' هنا إذا تم نقله
                        // await remove(ref(db, 'clients/' + id));
                        window.location.href = "contract.html"; // الانتقال لصفحة العقود
                    } catch (error) {
                        console.error("خطأ في نقل العميل للعقود:", error);
                        alert("❌ حدث خطأ أثناء نقل العميل للعقود.");
                    }
                } else {
                    alert("يجب إدخال رابط العقد ورابط الحسابات.");
                }
            } else {
                alert("لم يتم العثور على العميل المراد تأكيد عقده.");
            }
        };


        // الاستماع للتغيرات في قاعدة البيانات وعرض العملاء
        onValue(clientsRef, (snapshot) => {
            const data = snapshot.val();
            tbody.innerHTML = ""; // تفريغ الجدول قبل إعادة ملئه

            if (data) {
                // استخدام Object.entries لتحويل الكائنات إلى مصفوفة من [key, value]
                Object.entries(data).forEach(([id, client]) => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${client.code}</td>
                        <td>${client.name}</td>
                        <td>${client.phone}</td>
                        <td><a href="${client.estimate}" target="_blank"><img src="${client.estimate}" alt="عرض السعر"></a></td>
                        <td><a href="${client.drawings}" target="_blank"><img src="${client.drawings}" alt="الرسومات"></a></td>
                        <td>
                            <button class="action edit" data-id="${id}">✏️</button>
                            <button class="action delete" data-id="${id}">🗑️</button>
                            <button class="action contract" data-id="${id}">📄</button>
                        </td>
                    `;
                    tbody.appendChild(tr);

                    // إضافة مستمعي الأحداث للأزرار بعد إضافتها للـ DOM
                    tr.querySelector(".edit").addEventListener("click", () => editClient(id));
                    tr.querySelector(".delete").addEventListener("click", () => deleteClient(id));
                    tr.querySelector(".contract").addEventListener("click", () => confirmContract(id));
                });
            }
        });
    </script>

</body>
</html>
