<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: #f0f0f0;
            direction: rtl;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        form {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 0 10px #ccc;
            margin-bottom: 20px;
            max-width: 700px;
            margin: auto;
        }
        form input {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }
        form button {
            padding: 10px;
            width: 100%;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        table {
            width: 100%;
            background: white;
            border-collapse: collapse;
            margin-top: 20px;
            max-width: 1000px; /* Ù„Ø¬Ø¯ÙˆÙ„ Ø£ÙˆØ³Ø¹ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
            margin: 20px auto; /* Ù„ØªÙˆØ³ÙŠØ· Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
            vertical-align: middle; /* ØªÙˆØ³ÙŠØ· Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¹Ù…ÙˆØ¯ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ */
        }
        th {
            background: #eee;
        }
        .action {
            margin: 2px;
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1em; /* ØªÙƒØ¨ÙŠØ± Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        }
        .edit { background: #ffc107; color: black; }
        .delete { background: #dc3545; color: white; }
        .contract { background: #007bff; color: white; }
        td img {
            max-width: 100px; /* Ø­Ø¬Ù… Ø£ÙƒØ¨Ø± Ù„Ù„ØµÙˆØ± Ø¹Ø´Ø§Ù† ØªØ¨Ø§Ù† Ø£ÙˆØ¶Ø­ */
            height: auto;
            display: block;
            margin: auto; /* ØªÙˆØ³ÙŠØ· Ø§Ù„ØµÙˆØ±Ø© */
        }
    </style>
</head>
<body>

    <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h1>

    <form id="clientForm">
        <input type="text" id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" required>
        <input type="text" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required>
        <input type="url" id="estimate" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±" required>
        <input type="url" id="drawings" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª" required>
        <button type="submit">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
    </form>

    <table id="clientsTable">
        <thead>
            <tr>
                <th>Ø§Ù„ÙƒÙˆØ¯</th>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th>Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±</th>
                <th>Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª</th>
                <th>Ø®ÙŠØ§Ø±Ø§Øª</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import {
            getDatabase, ref, push, onValue, set, remove, get, child
        } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

        // Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ‡ÙŠØ¦Ø© Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
        // **Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©:** Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø¸Ø§Ù‡Ø±Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©ØŒ
        // ÙŠØ¬Ø¨ Ø£Ù† ØªØ¶Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firebase (Firebase Security Rules) Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
        // Ø£Ù†Ù‡Ø§ ØµØ§Ø±Ù…Ø© Ø¨Ù…Ø§ ÙŠÙƒÙÙŠ Ù„Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ ØºÙŠØ± Ø§Ù„Ù…ØµØ±Ø­ Ø¨Ù‡.
        const firebaseConfig = {
            apiKey: "AIzaSyDgOby-sJuIUs8iCErmqtiMbqMuND5ZtCo",
            authDomain: "ala5tsas-alturkey-stats.firebaseapp.com",
            databaseURL: "https://ala5tsas-alturkey-stats-default-rtdb.firebaseio.com",
            projectId: "ala5tsas-alturkey-stats",
            storageBucket: "ala5tsas-alturkey-stats.appspot.com", // ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„ØªØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            messagingSenderId: "649675735929",
            appId: "1:649675735929:web:f90a49614895c6958ea5a8",
            measurementId: "G-X2FHKZT21J"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const clientsRef = ref(db, 'clients');

        const form = document.getElementById("clientForm");
        const tbody = document.querySelector("#clientsTable tbody");

        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
        form.addEventListener("submit", async (e) => {
            e.preventDefault(); // Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ù†Ù…ÙˆØ°Ø¬
            const name = document.getElementById("name").value;
            const phone = document.getElementById("phone").value;
            const estimate = document.getElementById("estimate").value;
            const drawings = document.getElementById("drawings").value;

            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±Ø¬Ø¹ Ø¬Ø¯ÙŠØ¯ (key ÙØ±ÙŠØ¯) Ù„Ù„Ø¹Ù…ÙŠÙ„
            const newClientRef = push(clientsRef);
            await set(newClientRef, {
                code: newClientRef.key, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ key ÙƒÙƒÙˆØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„
                name,
                phone,
                estimate,
                drawings
            });

            form.reset(); // Ø¥ÙØ±Ø§Øº Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        });

        // Ø¯ÙˆØ§Ù„ Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø­Ø°ÙØŒ ØªØ¹Ø¯ÙŠÙ„ØŒ Ù†Ù‚Ù„ Ù„Ù„Ø¹Ù‚ÙˆØ¯)
        const deleteClient = async (id) => {
            if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ")) {
                try {
                    await remove(ref(db, 'clients/' + id));
                    alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.");
                } catch (error) {
                    console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„:", error);
                    alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„.");
                }
            }
        };

        const editClient = async (id) => {
            const snapshot = await get(child(ref(db), `clients/${id}`));
            if (snapshot.exists()) {
                const client = snapshot.val();
                const newName = prompt("Ø§Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:", client.name);
                const newPhone = prompt("Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯:", client.phone);
                const newEstimate = prompt("Ø§Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯:", client.estimate);
                const newDrawings = prompt("Ø§Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯:", client.drawings);

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ù„Ù… ØªÙƒÙ† ÙØ§Ø±ØºØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                if (newName !== null && newPhone !== null && newEstimate !== null && newDrawings !== null) {
                    try {
                        await set(ref(db, 'clients/' + id), {
                            code: id, // Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¸Ù„ ÙƒÙ…Ø§ Ù‡Ùˆ
                            name: newName,
                            phone: newPhone,
                            estimate: newEstimate,
                            drawings: newDrawings
                        });
                        alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.");
                    } catch (error) {
                        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…ÙŠÙ„:", error);
                        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…ÙŠÙ„.");
                    }
                } else {
                    alert("Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø£Ù† Ø£Ø­Ø¯ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙƒØ§Ù† ÙØ§Ø±ØºÙ‹Ø§ Ø£Ùˆ ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡.");
                }
            } else {
                alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ¹Ø¯ÙŠÙ„Ù‡.");
            }
        };

        const confirmContract = async (id) => {
            const snapshot = await get(child(ref(db), `clients/${id}`));
            if (snapshot.exists()) {
                const client = snapshot.val();
                const contractLink = prompt("Ø§Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù‚Ø¯:");
                const accountsLink = prompt("Ø§Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª:");

                if (contractLink && accountsLink) {
                    try {
                        await set(ref(db, 'contracts/' + id), {
                            code: client.code,
                            name: client.name,
                            phone: client.phone,
                            contract: contractLink,
                            accounts: accountsLink
                        });
                        alert("âœ… ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„Ø¹Ù‚ÙˆØ¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.");
                        // ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙÙƒÙŠØ± ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø¬Ø¯ÙˆÙ„ 'clients' Ù‡Ù†Ø§ Ø¥Ø°Ø§ ØªÙ… Ù†Ù‚Ù„Ù‡
                        // await remove(ref(db, 'clients/' + id));
                        window.location.href = "contract.html"; // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯
                    } catch (error) {
                        console.error("Ø®Ø·Ø£ ÙÙŠ Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„Ø¹Ù‚ÙˆØ¯:", error);
                        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„Ø¹Ù‚ÙˆØ¯.");
                    }
                } else {
                    alert("ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ±Ø§Ø¨Ø· Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.");
                }
            } else {
                alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ£ÙƒÙŠØ¯ Ø¹Ù‚Ø¯Ù‡.");
            }
        };


        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠØ±Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
        onValue(clientsRef, (snapshot) => {
            const data = snapshot.val();
            tbody.innerHTML = ""; // ØªÙØ±ÙŠØº Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ù„Ø¦Ù‡

            if (data) {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Object.entries Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ù…Ù† [key, value]
                Object.entries(data).forEach(([id, client]) => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${client.code}</td>
                        <td>${client.name}</td>
                        <td>${client.phone}</td>
                        <td><a href="${client.estimate}" target="_blank"><img src="${client.estimate}" alt="Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±"></a></td>
                        <td><a href="${client.drawings}" target="_blank"><img src="${client.drawings}" alt="Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª"></a></td>
                        <td>
                            <button class="action edit" data-id="${id}">âœï¸</button>
                            <button class="action delete" data-id="${id}">ğŸ—‘ï¸</button>
                            <button class="action contract" data-id="${id}">ğŸ“„</button>
                        </td>
                    `;
                    tbody.appendChild(tr);

                    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ù€ DOM
                    tr.querySelector(".edit").addEventListener("click", () => editClient(id));
                    tr.querySelector(".delete").addEventListener("click", () => deleteClient(id));
                    tr.querySelector(".contract").addEventListener("click", () => confirmContract(id));
                });
            }
        });
    </script>

</body>
</html>
