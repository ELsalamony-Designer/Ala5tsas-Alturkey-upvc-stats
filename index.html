<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>إدارة العملاء</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Cairo', sans-serif; direction: rtl; padding: 20px; background-color: #f8f9fa; color: #343a40; margin: 0; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    h2 { text-align: center; color: #007bff; }
    .top-buttons { display: flex; justify-content: flex-start; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    .top-buttons button, .top-buttons a { padding: 10px 20px; border-radius: 4px; font-weight: bold; font-size: 16px; color: white; border: none; cursor: pointer; text-decoration: none; }
    .btn-primary { background-color: #007bff; }
    .btn-add { background-color: #28a745; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; text-align: center; border: 1px solid #dee2e6; }
    th { background-color: #007bff; color: white; }
    .actions button { padding: 5px 10px; margin: 2px; border-radius: 4px; border: none; color: white; cursor: pointer; }
    .confirm-btn { background-color: #28a745; }
    .edit-btn { background-color: #6c757d; }
    .contract-btn { background-color: #007bff; }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-buttons">
      <button onclick="addRow()" class="btn-add">➕ إضافة عميل جديد</button>
    </div>
    <h2>📋 إدارة العملاء</h2>
    <table>
      <thead>
        <tr>
          <th>الكود</th>
          <th>اسم العميل</th>
          <th>رقم الهاتف</th>
          <th>عرض السعر</th>
          <th>الرسومات</th>
          <th>اسم البائع</th>
          <th>التحكم</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- Firebase config -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, set, remove, get, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC15Rb8pukWGcdDlmgEig8YGiIG27RGxJc",
      authDomain: "aaus-654c4.firebaseapp.com",
      databaseURL: "https://aaus-654c4-default-rtdb.firebaseio.com",
      projectId: "aaus-654c4",
      storageBucket: "aaus-654c4.appspot.com",
      messagingSenderId: "976513022962",
      appId: "1:976513022962:web:35f5ec4acfa0efef6e896b"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const storage = getStorage(app);

    let rowCount = 0;

    window.addRow = function () {
      const tableBody = document.getElementById("tableBody");
      const code = rowCount + 1;
      const row = tableBody.insertRow();
      row.setAttribute('data-code', code);
      row.innerHTML = `
        <td>${code}</td>
        <td><input type="text" id="name-${code}" placeholder="اسم العميل"></td>
        <td><input type="text" id="phone-${code}" placeholder="رقم الهاتف"></td>
        <td><input type="file" id="offer-${code}"></td>
        <td><input type="file" id="drawing-${code}"></td>
        <td>
          <select id="seller-${code}">
            <option value="أحمد">أحمد</option>
            <option value="محمود">محمود</option>
            <option value="نور">نور</option>
          </select>
        </td>
        <td class="actions">
          <button onclick="confirmRow('${code}')" class="confirm-btn">تأكيد</button>
          <button onclick="sendToContract('${code}')" class="contract-btn">عقد</button>
        </td>`;
      rowCount = code;
    };

    window.confirmRow = async function (code) {
      const name = document.getElementById(`name-${code}`).value.trim();
      const phone = document.getElementById(`phone-${code}`).value.trim();
      const seller = document.getElementById(`seller-${code}`).value;
      const offerFile = document.getElementById(`offer-${code}`).files[0];
      const drawingFile = document.getElementById(`drawing-${code}`).files[0];

      if (!name || !phone || !offerFile || !drawingFile) {
        alert("يرجى ملء جميع الحقول واختيار الملفات");
        return;
      }

      try {
        const offerPath = `offers/${Date.now()}_${offerFile.name}`;
        const drawingPath = `drawings/${Date.now()}_${drawingFile.name}`;

        const offerRef = sRef(storage, offerPath);
        const drawingRef = sRef(storage, drawingPath);

        await uploadBytes(offerRef, offerFile);
        await uploadBytes(drawingRef, drawingFile);

        const offerURL = await getDownloadURL(offerRef);
        const drawingURL = await getDownloadURL(drawingRef);

        await set(ref(database, "clients/" + code), {
          name,
          phone,
          seller,
          offerImage: offerURL,
          drawingImage: drawingURL
        });

        alert("✅ تم حفظ البيانات");
        location.reload();
      } catch (err) {
        alert("❌ خطأ أثناء الحفظ: " + err.message);
      }
    };

    window.sendToContract = async function (code) {
      if (!confirm("هل تريد نقل العميل إلى العقود؟")) return;
      const snapshot = await get(child(ref(database), "clients/" + code));
      if (!snapshot.exists()) return;
      const data = snapshot.val();
      await set(ref(database, "contracts/" + code), {
        name: data.name,
        phone: data.phone,
        seller: data.seller,
        contractImage: data.offerImage,
        accountsImage: data.drawingImage
      });
      await remove(ref(database, "clients/" + code));
      alert("✅ تم النقل إلى العقود");
      location.reload();
    };

    window.onload = function () {
      const dbRef = ref(database, "clients");
      const tableBody = document.getElementById("tableBody");
      get(dbRef).then(snapshot => {
        if (snapshot.exists()) {
          snapshot.forEach(childSnap => {
            const code = childSnap.key;
            const data = childSnap.val();
            const row = tableBody.insertRow();
            row.innerHTML = `
              <td>${code}</td>
              <td>${data.name}</td>
              <td>${data.phone}</td>
              <td><a href="${data.offerImage}" target="_blank">عرض</a></td>
              <td><a href="${data.drawingImage}" target="_blank">رسم</a></td>
              <td>${data.seller}</td>
              <td class="actions">
                <button onclick="sendToContract('${code}')" class="contract-btn">عقد</button>
              </td>`;
            if (+code > rowCount) rowCount = +code;
          });
        }
      });
    };
  </script>
</body>
</html>
