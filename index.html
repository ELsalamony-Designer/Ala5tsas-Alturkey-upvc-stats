<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>إدارة العملاء</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Cairo', sans-serif; background: #f2f2f2; direction: rtl; padding: 20px; }
    h1 { text-align: center; color: #333; }
    form { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px #ccc; max-width: 700px; margin: auto 0 20px; }
    form input, form button { display: block; width: 100%; margin: 10px 0; padding: 10px; border-radius: 6px; }
    form button { background: #28a745; color: white; border: none; font-weight: bold; cursor: pointer; }
    table { width: 100%; background: white; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background: #eee; }
    button.action { margin: 2px; padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; }
    .edit { background: #ffc107; color: black; }
    .delete { background: #dc3545; color: white; }
    .contract { background: #007bff; color: white; }
    #searchInput { width: calc(100% - 22px); padding: 10px; margin: auto 0 20px; display: block; max-width: 700px; }
  </style>
</head>
<body>

<h1>نظام إدارة العملاء</h1>

<form id="clientForm">
  <input type="text" id="name" placeholder="اسم العميل" required>
  <input type="text" id="phone" placeholder="رقم الهاتف" required>
  <input type="url" id="estimate" placeholder="رابط صورة عرض السعر" required>
  <input type="url" id="drawings" placeholder="رابط صورة الرسومات" required>
  <button type="submit">➕ إضافة عميل</button>
</form>

<input type="text" id="searchInput" placeholder="ابحث بالاسم أو الكود">

<table id="clientsTable">
  <thead>
    <tr>
      <th>الكود</th>
      <th>الاسم</th>
      <th>رقم الهاتف</th>
      <th>عرض السعر</th>
      <th>الرسومات</th>
      <th>خيارات</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, remove, get, child } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBFfikBhlWhcMUK50w3-GvaanceJjuQSBs",
    authDomain: "ala5tsas-alturkey-stats-56299.firebaseapp.com",
    databaseURL: "https://ala5tsas-alturkey-stats-56299-default-rtdb.firebaseio.com",
    projectId: "ala5tsas-alturkey-stats-56299",
    storageBucket: "ala5tsas-alturkey-stats-56299.firebasestorage.app",
    messagingSenderId: "432379375706",
    appId: "1:432379375706:web:843fc3cb6c445c56a3a863",
    measurementId: "G-CHYVT4EYFL"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const clientsRef = ref(db, 'clients');
  const contractsRef = ref(db, 'contracts');

  const form = document.getElementById("clientForm");
  const tbody = document.querySelector("#clientsTable tbody");
  const searchInput = document.getElementById("searchInput");

  form.addEventListener("submit", async e => {
    e.preventDefault();
    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const estimate = document.getElementById("estimate").value.trim();
    const drawings = document.getElementById("drawings").value.trim();
    if (!name || !phone || !estimate || !drawings) return alert("يرجى تعبئة جميع الحقول");

    const newRef = push(clientsRef);
    await set(newRef, { code: newRef.key, name, phone, estimate, drawings });
    form.reset();
  });

  onValue(clientsRef, snapshot => {
    const data = snapshot.val();
    tbody.innerHTML = "";
    if (data) {
      Object.entries(data).forEach(([id, client]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${client.code}</td>
          <td>${client.name}</td>
          <td>${client.phone}</td>
          <td><img src="${client.estimate}" width="60"></td>
          <td><img src="${client.drawings}" width="60"></td>
          <td>
            <button class="action edit" onclick="editClient('${id}')">✏️</button>
            <button class="action delete" onclick="deleteClient('${id}')">🗑️</button>
            <button class="action contract" onclick="confirmContract('${id}')">📄</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }
  });

  window.deleteClient = id => {
    if (confirm("هل تريد حذف هذا العميل؟")) remove(child(clientsRef, id));
  };

  window.editClient = async id => {
    const snap = await get(child(ref(db), `clients/${id}`));
    if (!snap.exists()) return alert("العميل غير موجود");
    const c = snap.val();
    const name = prompt("اسم جديد:", c.name);
    const phone = prompt("رقم جديد:", c.phone);
    const estimate = prompt("رابط عرض السعر:", c.estimate);
    const drawings = prompt("رابط الرسومات:", c.drawings);
    if (name && phone && estimate && drawings) {
      set(child(ref(db), `clients/${id}`), { code: id, name, phone, estimate, drawings });
    }
  };

  window.confirmContract = async id => {
    const snap = await get(child(ref(db), `clients/${id}`));
    if (!snap.exists()) return alert("العميل غير موجود");
    const c = snap.val();
    const contract = prompt("رابط صورة العقد:");
    const accounts = prompt("رابط صورة الحسابات:");
    if (!contract || !accounts) return alert("يرجى إدخال كل الروابط");
    await set(child(ref(db), `contracts/${id}`), {
      code: c.code, name: c.name, phone: c.phone, contract, accounts
    });
    alert("تم تأكيد العقد وانتقالك لصفحة العقود");
    window.location.href = "contract.html";
  };

  searchInput.addEventListener("input", () => {
    const filter = searchInput.value.toLowerCase();
    document.querySelectorAll("#clientsTable tbody tr").forEach(row => {
      const t0 = row.children[0].textContent.toLowerCase();
      const t1 = row.children[1].textContent.toLowerCase();
      row.style.display = t0.includes(filter) || t1.includes(filter) ? "" : "none";
    });
  });
</script>

</body>
</html>
