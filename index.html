<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Cairo', sans-serif; background: #f2f2f2; direction: rtl; padding: 20px; }
    h1 { text-align: center; color: #333; }
    form { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px #ccc; max-width: 700px; margin: auto 0 20px; }
    form input, form button { display: block; width: 100%; margin: 10px 0; padding: 10px; border-radius: 6px; }
    form button { background: #28a745; color: white; border: none; font-weight: bold; cursor: pointer; }
    table { width: 100%; background: white; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background: #eee; }
    button.action { margin: 2px; padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; }
    .edit { background: #ffc107; color: black; }
    .delete { background: #dc3545; color: white; }
    .contract { background: #007bff; color: white; }
    #searchInput { width: calc(100% - 22px); padding: 10px; margin: auto 0 20px; display: block; max-width: 700px; }
  </style>
</head>
<body>

<h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h1>

<form id="clientForm">
  <input type="text" id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" required>
  <input type="text" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required>
  <input type="url" id="estimate" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±" required>
  <input type="url" id="drawings" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª" required>
  <button type="submit">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
</form>

<input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯">

<table id="clientsTable">
  <thead>
    <tr>
      <th>Ø§Ù„ÙƒÙˆØ¯</th>
      <th>Ø§Ù„Ø§Ø³Ù…</th>
      <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
      <th>Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±</th>
      <th>Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª</th>
      <th>Ø®ÙŠØ§Ø±Ø§Øª</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, remove, get, child } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBFfikBhlWhcMUK50w3-GvaanceJjuQSBs",
    authDomain: "ala5tsas-alturkey-stats-56299.firebaseapp.com",
    databaseURL: "https://ala5tsas-alturkey-stats-56299-default-rtdb.firebaseio.com",
    projectId: "ala5tsas-alturkey-stats-56299",
    storageBucket: "ala5tsas-alturkey-stats-56299.firebasestorage.app",
    messagingSenderId: "432379375706",
    appId: "1:432379375706:web:843fc3cb6c445c56a3a863",
    measurementId: "G-CHYVT4EYFL"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const clientsRef = ref(db, 'clients');
  const contractsRef = ref(db, 'contracts');

  const form = document.getElementById("clientForm");
  const tbody = document.querySelector("#clientsTable tbody");
  const searchInput = document.getElementById("searchInput");

  form.addEventListener("submit", async e => {
    e.preventDefault();
    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const estimate = document.getElementById("estimate").value.trim();
    const drawings = document.getElementById("drawings").value.trim();
    if (!name || !phone || !estimate || !drawings) return alert("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");

    const newRef = push(clientsRef);
    await set(newRef, { code: newRef.key, name, phone, estimate, drawings });
    form.reset();
  });

  onValue(clientsRef, snapshot => {
    const data = snapshot.val();
    tbody.innerHTML = "";
    if (data) {
      Object.entries(data).forEach(([id, client]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${client.code}</td>
          <td>${client.name}</td>
          <td>${client.phone}</td>
          <td><img src="${client.estimate}" width="60"></td>
          <td><img src="${client.drawings}" width="60"></td>
          <td>
            <button class="action edit" onclick="editClient('${id}')">âœï¸</button>
            <button class="action delete" onclick="deleteClient('${id}')">ğŸ—‘ï¸</button>
            <button class="action contract" onclick="confirmContract('${id}')">ğŸ“„</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }
  });

  window.deleteClient = id => {
    if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ")) remove(child(clientsRef, id));
  };

  window.editClient = async id => {
    const snap = await get(child(ref(db), `clients/${id}`));
    if (!snap.exists()) return alert("Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
    const c = snap.val();
    const name = prompt("Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯:", c.name);
    const phone = prompt("Ø±Ù‚Ù… Ø¬Ø¯ÙŠØ¯:", c.phone);
    const estimate = prompt("Ø±Ø§Ø¨Ø· Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±:", c.estimate);
    const drawings = prompt("Ø±Ø§Ø¨Ø· Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª:", c.drawings);
    if (name && phone && estimate && drawings) {
      set(child(ref(db), `clients/${id}`), { code: id, name, phone, estimate, drawings });
    }
  };

  window.confirmContract = async id => {
    const snap = await get(child(ref(db), `clients/${id}`));
    if (!snap.exists()) return alert("Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
    const c = snap.val();
    const contract = prompt("Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù‚Ø¯:");
    const accounts = prompt("Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª:");
    if (!contract || !accounts) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·");
    await set(child(ref(db), `contracts/${id}`), {
      code: c.code, name: c.name, phone: c.phone, contract, accounts
    });
    alert("ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ§Ù†ØªÙ‚Ø§Ù„Ùƒ Ù„ØµÙØ­Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯");
    window.location.href = "contract.html";
  };

  searchInput.addEventListener("input", () => {
    const filter = searchInput.value.toLowerCase();
    document.querySelectorAll("#clientsTable tbody tr").forEach(row => {
      const t0 = row.children[0].textContent.toLowerCase();
      const t1 = row.children[1].textContent.toLowerCase();
      row.style.display = t0.includes(filter) || t1.includes(filter) ? "" : "none";
    });
  });
</script>

</body>
</html>
